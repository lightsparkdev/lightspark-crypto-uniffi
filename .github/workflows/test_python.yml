name: Test python build on linux
on: [workflow_dispatch]

jobs:
  build-manylinux2014-arm64-wheels:
    name: "Build Manylinux 2014 aarch64 wheel"
    runs-on: macos-13
    defaults:
      run:
        working-directory: lightspark-crypto-python
    strategy:
      matrix:
        python: # Update this list whenever the docker image is updated (check /opt/python/)
          - "3.10"
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: "Install Python"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: cargo tree
        run: cargo tree

      - name: "Generate py source and binaries"
        run: bash ./scripts/generate-linux-arm64.sh

      - name: "Build wheel"
        run: python3 setup.py bdist_wheel --plat-name manylinux_2_17_aarch64 --verbose

      - run: pwd
      - run: ls dist

      - name: "Upload artifacts"
        uses: actions/upload-artifact@v3
        with:
          name: lightspark_crypto_python-manylinux2014-aarch64-${{ matrix.python }}
          path: /home/runner/work/lightspark-crypto-uniffi/lightspark-crypto-python/dist/*.whl
